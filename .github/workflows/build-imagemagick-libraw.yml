name: Build ImageMagick with libraw

on:
  workflow_dispatch:
    inputs:
      imagemagick-version:
        description: "ImageMagick version to build (e.g., 7.1.1-47, 7.1.1-48)"
        required: true
        default: "7.1.1-47"

permissions:
  contents: write

jobs:
  build-x86_64:
    runs-on: macos-15-intel

    steps:
      - name: Download xcpkg
        run: |
          curl -LO https://raw.githubusercontent.com/leleliu008/xcpkg/master/xcpkg
          chmod +x xcpkg

      - name: Patch xcpkg for missing compiler environment variables
        run: |
          # xcpkg has a bug where it doesn't set XCPKG_COMPILER_* variables needed by wrapper scripts
          # Add XCPKG_COMPILER_ARGS right after XCPKG_TARGET_FLAGS
          sed -i.bak1 '/export XCPKG_TARGET_FLAGS=.*-Qunused-arguments"$/a\
              export XCPKG_COMPILER_ARGS="$XCPKG_TARGET_FLAGS"
          ' xcpkg

          # Add XCPKG_COMPILER_* variables after XCPKG_OBJC
          sed -i.bak2 '/export XCPKG_OBJC="\$XCODE_CC"$/a\
              export XCPKG_COMPILER_C="$XCODE_CC"\
              export XCPKG_COMPILER_CXX="$XCODE_CXX"\
              export XCPKG_COMPILER_OBJC="$XCODE_CC"
          ' xcpkg

          # Add XCPKG_COMPILER_ARGS_FOR_BUILD after XCPKG_NATIVE_FLAGS
          sed -i.bak3 '/export XCPKG_NATIVE_FLAGS=.*-Qunused-arguments"$/a\
              export XCPKG_COMPILER_ARGS_FOR_BUILD="$XCPKG_NATIVE_FLAGS"
          ' xcpkg

          # Add compiler variables to native package installation function
          sed -i.bak4 '/export LDFLAGS="-L\$PACKAGE_WORKING_DIR\/lib -Wl,-rpath,\$PACKAGE_INSTALL_DIR\/lib \$LDFLAGS"$/a\
          \
              # Set compiler variables for wrappers\
              export XCPKG_COMPILER_C="$XCODE_CC"\
              export XCPKG_COMPILER_CXX="$XCODE_CXX"\
              export XCPKG_COMPILER_OBJC="$XCODE_CC"\
              export XCPKG_COMPILER_ARGS_FOR_BUILD="$XCPKG_NATIVE_FLAGS"
          ' xcpkg


          rm -f xcpkg.bak*
          echo "✅ xcpkg patched successfully"

      - name: Setup xcpkg
        run: ./xcpkg setup

      - name: Wrap uppm with retry logic
        run: |
          set -euo pipefail
          UPPM_CORE="$HOME/.xcpkg/core"
          echo "Wrapping uppm in $UPPM_CORE"
          if [ ! -d "$UPPM_CORE" ]; then
            echo "uppm core directory not found: $UPPM_CORE"
            exit 1
          fi

          if [ -f "$UPPM_CORE/uppm" ] && [ ! -f "$UPPM_CORE/uppm.real" ]; then
            mv "$UPPM_CORE/uppm" "$UPPM_CORE/uppm.real"
          fi

          if [ ! -f "$UPPM_CORE/uppm.real" ]; then
            echo "Expected uppm binary at $UPPM_CORE/uppm.real but not found"
            ls -l "$UPPM_CORE"
            exit 1
          fi

          WRAPPER="$UPPM_CORE/uppm"
          REAL="$UPPM_CORE/uppm.real"
          RETRY_MAX='${UPPM_INSTALL_MAX_RETRIES:-5}'
          RETRY_DELAY='${UPPM_INSTALL_RETRY_DELAY:-5}'

          printf '%s\n' \
            '#!/bin/bash' \
            'set -euo pipefail' \
            '' \
            'SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"' \
            'UPPM_REAL="$SCRIPT_DIR/uppm.real"' \
            '' \
            'attempt=1' \
            "max_attempts=$RETRY_MAX" \
            '' \
            'while true; do' \
            '  "$UPPM_REAL" "$@"' \
            '  status=$?' \
            '  if [ $status -eq 0 ]; then' \
            '    exit 0' \
            '  fi' \
            '' \
            '  if [ $attempt -ge $max_attempts ]; then' \
            '    echo "uppm failed after $max_attempts attempts (exit $status)" >&2' \
            '    exit $status' \
            '  fi' \
            '' \
            "  delay=\$((attempt * $RETRY_DELAY))" \
            '  echo "uppm failed with status $status (attempt $attempt/$max_attempts). Retrying in ${delay}s..." >&2' \
            '  sleep $delay' \
            '  attempt=$((attempt + 1))' \
            'done' \
            > "$WRAPPER"

          chmod +x "$WRAPPER"

      - name: Update xcpkg formulas
        run: ./xcpkg update

      - name: Patch all formulas to use reliable mirrors
        run: |
          FORMULA_DIR=~/.xcpkg/repos.d/official-core/formula

          echo "Patching all formulas to replace unreliable mirrors..."

          # Find all formulas that use fossies.org or ftpmirror.gnu.org and patch them
          for formula in "$FORMULA_DIR"/*.yml; do
            if grep -qE "fossies\.org|ftpmirror\.gnu\.org" "$formula" 2>/dev/null; then
              echo "Patching $(basename "$formula")..."
              
              # Replace libtool URLs from fossies.org to kernel.org mirrors (very reliable)
              sed -i '' 's|https\?://fossies\.org/linux/misc/libtool-\([^"]*\)|https://mirrors.kernel.org/gnu/libtool/libtool-\1|g' "$formula"
              
              # Replace ftpmirror.gnu.org with mirrors.kernel.org
              sed -i '' 's|https\?://ftpmirror\.gnu\.org/gnu/\([^"]*\)|https://mirrors.kernel.org/gnu/\1|g' "$formula"
              
              # Show what we changed
              echo "  New URL: $(grep 'src-url:' "$formula" | head -1)"
            fi
          done

          # Clear download cache to force re-download from new URLs
          echo "Clearing download cache..."
          rm -rf ~/.xcpkg/downloads/* || true

          echo "✅ Formula patching complete"

      - name: Patch libaom formula for portability
        run: |
          # Enable runtime CPU detection to avoid illegal hardware instructions on older CPUs
          sed -i.bak "s/-DCONFIG_RUNTIME_CPU_DETECT=0/-DCONFIG_RUNTIME_CPU_DETECT=1/g" ~/.xcpkg/repos.d/official-core/formula/libaom.yml

          echo "Patched libaom formula:"
          grep "CONFIG_RUNTIME_CPU_DETECT" ~/.xcpkg/repos.d/official-core/formula/libaom.yml

      - name: Replace ImageMagick formula with custom version (includes libraw)
        run: |
          curl -o ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml \
            https://raw.githubusercontent.com/jakemanger/xcpkg-formula-repository-official-core/master/formula/imagemagick.yml

          # Update version if different from default
          if [ "${{ github.event.inputs.imagemagick-version }}" != "7.1.1-47" ]; then
            VERSION="${{ github.event.inputs.imagemagick-version }}"
            echo "Updating ImageMagick formula to version $VERSION"
            
            # Download the new version to calculate SHA256
            NEW_URL="https://imagemagick.org/archive/releases/ImageMagick-$VERSION.tar.xz"
            echo "Downloading $NEW_URL to calculate checksum..."
            curl -LO "$NEW_URL"
            
            # Calculate SHA256
            NEW_SHA256=$(shasum -a 256 "ImageMagick-$VERSION.tar.xz" | awk '{print $1}')
            echo "Calculated SHA256: $NEW_SHA256"
            
            # Clean up downloaded file
            rm "ImageMagick-$VERSION.tar.xz"
            
            # Update the formula
            sed -i.bak "s/7\.1\.1-47/$VERSION/g" ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml
            sed -i.bak2 "s|ImageMagick-7\.1\.1-47|ImageMagick-$VERSION|g" ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml
            sed -i.bak3 "s/src-sha: .*/src-sha: $NEW_SHA256/" ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml
            
            rm -f ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml.bak*
            
            echo "Updated formula:"
            grep -E "src-url:|src-sha:" ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml
          fi

          echo "Custom ImageMagick formula with libraw installed"

      - name: Build ImageMagick with libraw support
        run: ./xcpkg install MacOSX-15.0-x86_64/imagemagick --profile=release

      - name: Verify libraw support
        run: |
          MAGICK_PATH=$(find ~/.xcpkg/installed/MacOSX-15.0-x86_64 -name "magick" -type f | head -1)
          echo "ImageMagick binary: $MAGICK_PATH"

          echo "Version:"
          "$MAGICK_PATH" -version | head -5

          echo ""
          echo "Checking for libraw support:"
          "$MAGICK_PATH" -version | grep -i raw || echo "No 'raw' in version output"

          echo ""
          echo "Supported formats (RAW):"
          "$MAGICK_PATH" -list format | grep -iE "dng|cr2|cr3|nef|arw|orf|raf|rw2|sr2" || echo "No RAW formats found"

      - name: Package ImageMagick binary
        run: |
          ./xcpkg bundle MacOSX-15.0-x86_64/imagemagick .tar.xz
          ls -lh *.tar.xz

          # Extract, strip top-level directory, and repackage for ConvertSave
          mkdir -p repack
          xz -d imagemagick-*.tar.xz
          tar -xf imagemagick-*.tar --strip-components=1 -C repack/
          rm imagemagick-*.tar

          # Create new tarball without extra directory level
          cd repack
          tar -czf ../imagemagick-macos-x86_64.tar.gz .
          cd ..

          ls -lh imagemagick-macos-x86_64.tar.gz
          echo "Contents of archive:"
          tar -tzf imagemagick-macos-x86_64.tar.gz | head -20

      - name: Upload ImageMagick artifact
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-macos-x86_64
          path: imagemagick-macos-x86_64.tar.gz
          retention-days: 30

  build-arm64:
    runs-on: macos-15

    steps:
      - name: Download xcpkg
        run: |
          curl -LO https://raw.githubusercontent.com/leleliu008/xcpkg/master/xcpkg
          chmod +x xcpkg

      - name: Patch xcpkg for missing compiler environment variables
        run: |
          # xcpkg has a bug where it doesn't set XCPKG_COMPILER_* variables needed by wrapper scripts
          # Add XCPKG_COMPILER_ARGS right after XCPKG_TARGET_FLAGS
          sed -i.bak1 '/export XCPKG_TARGET_FLAGS=.*-Qunused-arguments"$/a\
              export XCPKG_COMPILER_ARGS="$XCPKG_TARGET_FLAGS"
          ' xcpkg

          # Add XCPKG_COMPILER_* variables after XCPKG_OBJC
          sed -i.bak2 '/export XCPKG_OBJC="\$XCODE_CC"$/a\
              export XCPKG_COMPILER_C="$XCODE_CC"\
              export XCPKG_COMPILER_CXX="$XCODE_CXX"\
              export XCPKG_COMPILER_OBJC="$XCODE_CC"
          ' xcpkg

          # Add XCPKG_COMPILER_ARGS_FOR_BUILD after XCPKG_NATIVE_FLAGS
          sed -i.bak3 '/export XCPKG_NATIVE_FLAGS=.*-Qunused-arguments"$/a\
              export XCPKG_COMPILER_ARGS_FOR_BUILD="$XCPKG_NATIVE_FLAGS"
          ' xcpkg

          # Add compiler variables to native package installation function
          sed -i.bak4 '/export LDFLAGS="-L\$PACKAGE_WORKING_DIR\/lib -Wl,-rpath,\$PACKAGE_INSTALL_DIR\/lib \$LDFLAGS"$/a\
          \
              # Set compiler variables for wrappers\
              export XCPKG_COMPILER_C="$XCODE_CC"\
              export XCPKG_COMPILER_CXX="$XCODE_CXX"\
              export XCPKG_COMPILER_OBJC="$XCODE_CC"\
              export XCPKG_COMPILER_ARGS_FOR_BUILD="$XCPKG_NATIVE_FLAGS"
          ' xcpkg


          rm -f xcpkg.bak*
          echo "✅ xcpkg patched successfully"

      - name: Setup xcpkg
        run: ./xcpkg setup

      - name: Wrap uppm with retry logic
        run: |
          set -euo pipefail
          UPPM_CORE="$HOME/.xcpkg/core"
          echo "Wrapping uppm in $UPPM_CORE"
          if [ ! -d "$UPPM_CORE" ]; then
            echo "uppm core directory not found: $UPPM_CORE"
            exit 1
          fi

          if [ -f "$UPPM_CORE/uppm" ] && [ ! -f "$UPPM_CORE/uppm.real" ]; then
            mv "$UPPM_CORE/uppm" "$UPPM_CORE/uppm.real"
          fi

          if [ ! -f "$UPPM_CORE/uppm.real" ]; then
            echo "Expected uppm binary at $UPPM_CORE/uppm.real but not found"
            ls -l "$UPPM_CORE"
            exit 1
          fi

          WRAPPER="$UPPM_CORE/uppm"
          REAL="$UPPM_CORE/uppm.real"
          RETRY_MAX='${UPPM_INSTALL_MAX_RETRIES:-5}'
          RETRY_DELAY='${UPPM_INSTALL_RETRY_DELAY:-5}'

          printf '%s\n' \
            '#!/bin/bash' \
            'set -euo pipefail' \
            '' \
            'SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"' \
            'UPPM_REAL="$SCRIPT_DIR/uppm.real"' \
            '' \
            'attempt=1' \
            "max_attempts=$RETRY_MAX" \
            '' \
            'while true; do' \
            '  "$UPPM_REAL" "$@"' \
            '  status=$?' \
            '  if [ $status -eq 0 ]; then' \
            '    exit 0' \
            '  fi' \
            '' \
            '  if [ $attempt -ge $max_attempts ]; then' \
            '    echo "uppm failed after $max_attempts attempts (exit $status)" >&2' \
            '    exit $status' \
            '  fi' \
            '' \
            "  delay=\$((attempt * $RETRY_DELAY))" \
            '  echo "uppm failed with status $status (attempt $attempt/$max_attempts). Retrying in ${delay}s..." >&2' \
            '  sleep $delay' \
            '  attempt=$((attempt + 1))' \
            'done' \
            > "$WRAPPER"

          chmod +x "$WRAPPER"

      - name: Update xcpkg formulas
        run: ./xcpkg update

      - name: Patch libaom formula for portability
        run: |
          # Enable runtime CPU detection to avoid illegal hardware instructions on older CPUs
          sed -i.bak "s/-DCONFIG_RUNTIME_CPU_DETECT=0/-DCONFIG_RUNTIME_CPU_DETECT=1/g" ~/.xcpkg/repos.d/official-core/formula/libaom.yml

          echo "Patched libaom formula:"
          grep "CONFIG_RUNTIME_CPU_DETECT" ~/.xcpkg/repos.d/official-core/formula/libaom.yml

      - name: Replace ImageMagick formula with custom version (includes libraw)
        run: |
          curl -o ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml \
            https://raw.githubusercontent.com/jakemanger/xcpkg-formula-repository-official-core/master/formula/imagemagick.yml

          # Update version if different from default
          if [ "${{ github.event.inputs.imagemagick-version }}" != "7.1.1-47" ]; then
            VERSION="${{ github.event.inputs.imagemagick-version }}"
            echo "Updating ImageMagick formula to version $VERSION"
            
            # Download the new version to calculate SHA256
            NEW_URL="https://imagemagick.org/archive/releases/ImageMagick-$VERSION.tar.xz"
            echo "Downloading $NEW_URL to calculate checksum..."
            curl -LO "$NEW_URL"
            
            # Calculate SHA256
            NEW_SHA256=$(shasum -a 256 "ImageMagick-$VERSION.tar.xz" | awk '{print $1}')
            echo "Calculated SHA256: $NEW_SHA256"
            
            # Clean up downloaded file
            rm "ImageMagick-$VERSION.tar.xz"
            
            # Update the formula
            sed -i.bak "s/7\.1\.1-47/$VERSION/g" ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml
            sed -i.bak2 "s|ImageMagick-7\.1\.1-47|ImageMagick-$VERSION|g" ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml
            sed -i.bak3 "s/src-sha: .*/src-sha: $NEW_SHA256/" ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml
            
            rm -f ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml.bak*
            
            echo "Updated formula:"
            grep -E "src-url:|src-sha:" ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml
          fi

          echo "Custom ImageMagick formula with libraw installed"

      - name: Build ImageMagick with libraw support
        run: ./xcpkg install MacOSX-15.0-arm64/imagemagick --profile=release

      - name: Verify libraw support
        run: |
          MAGICK_PATH=$(find ~/.xcpkg/installed/MacOSX-15.0-arm64 -name "magick" -type f | head -1)
          echo "ImageMagick binary: $MAGICK_PATH"

          echo "Version:"
          "$MAGICK_PATH" -version | head -5

          echo ""
          echo "Checking for libraw support:"
          "$MAGICK_PATH" -version | grep -i raw || echo "No 'raw' in version output"

          echo ""
          echo "Supported formats (RAW):"
          "$MAGICK_PATH" -list format | grep -iE "dng|cr2|cr3|nef|arw|orf|raf|rw2|sr2" || echo "No RAW formats found"

      - name: Package ImageMagick binary
        run: |
          ./xcpkg bundle MacOSX-15.0-arm64/imagemagick .tar.xz
          ls -lh *.tar.xz

          # Extract, strip top-level directory, and repackage for ConvertSave
          mkdir -p repack
          xz -d imagemagick-*.tar.xz
          tar -xf imagemagick-*.tar --strip-components=1 -C repack/
          rm imagemagick-*.tar

          # Create new tarball without extra directory level
          cd repack
          tar -czf ../imagemagick-macos-arm64.tar.gz .
          cd ..

          ls -lh imagemagick-macos-arm64.tar.gz
          echo "Contents of archive:"
          tar -tzf imagemagick-macos-arm64.tar.gz | head -20

      - name: Upload ImageMagick artifact
        uses: actions/upload-artifact@v4
        with:
          name: imagemagick-macos-arm64
          path: imagemagick-macos-arm64.tar.gz
          retention-days: 30

  release:
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update 'latest' release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest ImageMagick Build
          body: |
            Latest ImageMagick built with xcpkg (using How to Convert's patching approach)

            ## Files:

            - `imagemagick-macos-x86_64.tar.gz` - **Intel Macs** (x86_64)
            - `imagemagick-macos-arm64.tar.gz` - **Apple Silicon** (ARM64)

            Built using xcpkg with How to Convert's imagemagick formula and xcpkg patches.
            Includes full libraw support for RAW image formats.
            Compatible with macOS 11+.
          files: |
            artifacts/**/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
