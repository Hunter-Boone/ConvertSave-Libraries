name: Build ImageMagick with xcpkg

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [x86_64, arm64]

    steps:
      - id: prepare
        run: |
          if [ ${{ matrix.arch }} = x86_64 ] ; then
              printf 'RUNS_ON=macos-13\n' >> "$GITHUB_OUTPUT"
          else
              printf 'RUNS_ON=macos-14\n' >> "$GITHUB_OUTPUT"
          fi

    outputs:
      runs-on-x86_64: ${{ matrix.arch == 'x86_64' && steps.prepare.outputs.RUNS_ON || '' }}
      runs-on-arm64: ${{ matrix.arch == 'arm64' && steps.prepare.outputs.RUNS_ON || '' }}

  build-x86_64:
    needs: prepare
    runs-on: macos-13

    steps:
      - run: export -p

      - run: curl -LO https://raw.githubusercontent.com/leleliu008/xcpkg/master/xcpkg
      - run: chmod a+x xcpkg
      - run: ./xcpkg setup
      - run: ./xcpkg update

      # Download custom imagemagick formula with libraw support
      - run: |
          mkdir -p ~/.xcpkg/repos.d/official-core/formula
          curl -o ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml https://raw.githubusercontent.com/jakemanger/xcpkg-formula-repository-official-core/master/formula/imagemagick.yml

      - name: Patch xcpkg wrapper scripts to use clang directly
        run: |
          SDK_PATH="$(xcrun --show-sdk-path)"
          echo "SDK Path: $SDK_PATH"
          
          # Replace wrapper-native-cc with direct clang invocation
          cat > ~/.xcpkg/core/wrapper-native-cc << 'EOF'
#!/bin/sh
SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '')"
if [ -n "$SDK_PATH" ]; then
  exec /usr/bin/clang -arch x86_64 -mmacosx-version-min=13.0 -isysroot "$SDK_PATH" "$@"
else
  exec /usr/bin/clang -arch x86_64 -mmacosx-version-min=13.0 "$@"
fi
EOF
          chmod +x ~/.xcpkg/core/wrapper-native-cc
          
          # Replace wrapper-native-c++ with direct clang++ invocation
          cat > ~/.xcpkg/core/wrapper-native-c++ << 'EOF'
#!/bin/sh
SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '')"
if [ -n "$SDK_PATH" ]; then
  exec /usr/bin/clang++ -arch x86_64 -mmacosx-version-min=13.0 -isysroot "$SDK_PATH" "$@"
else
  exec /usr/bin/clang++ -arch x86_64 -mmacosx-version-min=13.0 "$@"
fi
EOF
          chmod +x ~/.xcpkg/core/wrapper-native-c++
          
          # Replace wrapper-target-cc with direct clang invocation
          cat > ~/.xcpkg/core/wrapper-target-cc << 'EOF'
#!/bin/sh
SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '')"
if [ -n "$SDK_PATH" ]; then
  exec /usr/bin/clang -arch x86_64 -mmacosx-version-min=13.0 -isysroot "$SDK_PATH" "$@"
else
  exec /usr/bin/clang -arch x86_64 -mmacosx-version-min=13.0 "$@"
fi
EOF
          chmod +x ~/.xcpkg/core/wrapper-target-cc
          
          # Replace wrapper-target-c++ with direct clang++ invocation
          cat > ~/.xcpkg/core/wrapper-target-c++ << 'EOF'
#!/bin/sh
SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '')"
if [ -n "$SDK_PATH" ]; then
  exec /usr/bin/clang++ -arch x86_64 -mmacosx-version-min=13.0 -isysroot "$SDK_PATH" "$@"
else
  exec /usr/bin/clang++ -arch x86_64 -mmacosx-version-min=13.0 "$@"
fi
EOF
          chmod +x ~/.xcpkg/core/wrapper-target-c++
          
          echo "Wrapper scripts patched successfully"

      - name: Build ImageMagick with xcpkg
        run: ./xcpkg install MacOSX-13.0-x86_64/imagemagick --profile=release

      - run: ./xcpkg pack MacOSX-13.0-x86_64/imagemagick -t tar.gz -o .

      - run: mv imagemagick-*.tar.gz imagemagick-macos-x86_64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: imagemagick-macos-x86_64
          path: imagemagick-macos-x86_64.tar.gz

  build-arm64:
    needs: prepare
    runs-on: macos-14

    steps:
      - run: export -p

      - run: curl -LO https://raw.githubusercontent.com/leleliu008/xcpkg/master/xcpkg
      - run: chmod a+x xcpkg
      - run: ./xcpkg setup
      - run: ./xcpkg update

      # Download custom imagemagick formula with libraw support
      - run: |
          mkdir -p ~/.xcpkg/repos.d/official-core/formula
          curl -o ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml https://raw.githubusercontent.com/jakemanger/xcpkg-formula-repository-official-core/master/formula/imagemagick.yml

      - name: Patch xcpkg wrapper scripts to use clang directly
        run: |
          SDK_PATH="$(xcrun --show-sdk-path)"
          echo "SDK Path: $SDK_PATH"
          
          # Replace wrapper-native-cc with direct clang invocation
          cat > ~/.xcpkg/core/wrapper-native-cc << 'EOF'
#!/bin/sh
SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '')"
if [ -n "$SDK_PATH" ]; then
  exec /usr/bin/clang -arch arm64 -mmacosx-version-min=14.0 -isysroot "$SDK_PATH" "$@"
else
  exec /usr/bin/clang -arch arm64 -mmacosx-version-min=14.0 "$@"
fi
EOF
          chmod +x ~/.xcpkg/core/wrapper-native-cc
          
          # Replace wrapper-native-c++ with direct clang++ invocation
          cat > ~/.xcpkg/core/wrapper-native-c++ << 'EOF'
#!/bin/sh
SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '')"
if [ -n "$SDK_PATH" ]; then
  exec /usr/bin/clang++ -arch arm64 -mmacosx-version-min=14.0 -isysroot "$SDK_PATH" "$@"
else
  exec /usr/bin/clang++ -arch arm64 -mmacosx-version-min=14.0 "$@"
fi
EOF
          chmod +x ~/.xcpkg/core/wrapper-native-c++
          
          # Replace wrapper-target-cc with direct clang invocation
          cat > ~/.xcpkg/core/wrapper-target-cc << 'EOF'
#!/bin/sh
SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '')"
if [ -n "$SDK_PATH" ]; then
  exec /usr/bin/clang -arch arm64 -mmacosx-version-min=14.0 -isysroot "$SDK_PATH" "$@"
else
  exec /usr/bin/clang -arch arm64 -mmacosx-version-min=14.0 "$@"
fi
EOF
          chmod +x ~/.xcpkg/core/wrapper-target-cc
          
          # Replace wrapper-target-c++ with direct clang++ invocation
          cat > ~/.xcpkg/core/wrapper-target-c++ << 'EOF'
#!/bin/sh
SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '')"
if [ -n "$SDK_PATH" ]; then
  exec /usr/bin/clang++ -arch arm64 -mmacosx-version-min=14.0 -isysroot "$SDK_PATH" "$@"
else
  exec /usr/bin/clang++ -arch arm64 -mmacosx-version-min=14.0 "$@"
fi
EOF
          chmod +x ~/.xcpkg/core/wrapper-target-c++
          
          echo "Wrapper scripts patched successfully"

      - name: Build ImageMagick with xcpkg
        run: ./xcpkg install MacOSX-14.0-arm64/imagemagick --profile=release

      - run: ./xcpkg pack MacOSX-14.0-arm64/imagemagick -t tar.gz -o .

      - run: mv imagemagick-*.tar.gz imagemagick-macos-arm64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: imagemagick-macos-arm64
          path: imagemagick-macos-arm64.tar.gz

  release:
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update 'latest' release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest ImageMagick Build
          body: |
            Latest ImageMagick built with xcpkg (like How to Convert)

            ## Files:

            - `imagemagick-macos-x86_64.tar.gz` - **Intel Macs** (x86_64)
            - `imagemagick-macos-arm64.tar.gz` - **Apple Silicon** (ARM64)

            Built using xcpkg with How to Convert's imagemagick formula.
            Compatible with macOS 11+.
          files: |
            artifacts/**/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
