name: Build ImageMagick with xcpkg

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [x86_64, arm64]

    steps:
      - id: prepare
        run: |
          if [ ${{ matrix.arch }} = x86_64 ] ; then
              printf 'RUNS_ON=macos-13\n' >> "$GITHUB_OUTPUT"
          else
              printf 'RUNS_ON=macos-14\n' >> "$GITHUB_OUTPUT"
          fi

    outputs:
      runs-on-x86_64: ${{ matrix.arch == 'x86_64' && steps.prepare.outputs.RUNS_ON || '' }}
      runs-on-arm64: ${{ matrix.arch == 'arm64' && steps.prepare.outputs.RUNS_ON || '' }}

  build-x86_64:
    needs: prepare
    runs-on: macos-13

    steps:
      - run: export -p

      - run: curl -LO https://raw.githubusercontent.com/leleliu008/xcpkg/master/xcpkg
      - run: chmod a+x xcpkg
      - run: ./xcpkg setup
      - run: ./xcpkg update

      # Download custom imagemagick formula with libraw support
      - run: |
          mkdir -p ~/.xcpkg/repos.d/official-core/formula
          curl -o ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml https://raw.githubusercontent.com/jakemanger/xcpkg-formula-repository-official-core/master/formula/imagemagick.yml

      - name: Configure and verify compiler environment
        run: |
          SDK_PATH="$(xcrun --show-sdk-path)"
          echo "SDK Path: $SDK_PATH"

          # Write environment to a file that will be sourced by all shell commands
          cat >> ~/.bashrc << EOF
          export XCPKG_COMPILER_C="/usr/bin/clang"
          export XCPKG_COMPILER_CXX="/usr/bin/clang++"
          export XCPKG_SDK_ROOT="$SDK_PATH"
          export XCPKG_COMPILER_ARGS="-arch x86_64 -mmacosx-version-min=13.0 -isysroot $SDK_PATH"
          export XCPKG_NATIVE_COMPILER_C="/usr/bin/clang"
          export XCPKG_NATIVE_COMPILER_CXX="/usr/bin/clang++"
          export XCPKG_NATIVE_COMPILER_ARGS="-arch x86_64 -mmacosx-version-min=13.0 -isysroot $SDK_PATH"
          EOF

          source ~/.bashrc

          echo "Verifying environment variables:"
          echo "XCPKG_COMPILER_C=$XCPKG_COMPILER_C"
          echo "XCPKG_COMPILER_ARGS=$XCPKG_COMPILER_ARGS"
          echo "XCPKG_NATIVE_COMPILER_C=$XCPKG_NATIVE_COMPILER_C"
          echo "XCPKG_NATIVE_COMPILER_ARGS=$XCPKG_NATIVE_COMPILER_ARGS"

      - name: Build ImageMagick with xcpkg
        shell: bash -leo pipefail {0}
        run: |
          source ~/.bashrc
          ./xcpkg install MacOSX-13.0-x86_64/imagemagick --profile=release

      - run: ./xcpkg pack MacOSX-13.0-x86_64/imagemagick -t tar.gz -o .

      - run: mv imagemagick-*.tar.gz imagemagick-macos-x86_64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: imagemagick-macos-x86_64
          path: imagemagick-macos-x86_64.tar.gz

  build-arm64:
    needs: prepare
    runs-on: macos-14

    steps:
      - run: export -p

      - run: curl -LO https://raw.githubusercontent.com/leleliu008/xcpkg/master/xcpkg
      - run: chmod a+x xcpkg
      - run: ./xcpkg setup
      - run: ./xcpkg update

      # Download custom imagemagick formula with libraw support
      - run: |
          mkdir -p ~/.xcpkg/repos.d/official-core/formula
          curl -o ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml https://raw.githubusercontent.com/jakemanger/xcpkg-formula-repository-official-core/master/formula/imagemagick.yml

      - name: Configure and verify compiler environment
        run: |
          SDK_PATH="$(xcrun --show-sdk-path)"
          echo "SDK Path: $SDK_PATH"

          # Write environment to a file that will be sourced by all shell commands
          cat >> ~/.bashrc << EOF
          export XCPKG_COMPILER_C="/usr/bin/clang"
          export XCPKG_COMPILER_CXX="/usr/bin/clang++"
          export XCPKG_SDK_ROOT="$SDK_PATH"
          export XCPKG_COMPILER_ARGS="-arch arm64 -mmacosx-version-min=14.0 -isysroot $SDK_PATH"
          export XCPKG_NATIVE_COMPILER_C="/usr/bin/clang"
          export XCPKG_NATIVE_COMPILER_CXX="/usr/bin/clang++"
          export XCPKG_NATIVE_COMPILER_ARGS="-arch arm64 -mmacosx-version-min=14.0 -isysroot $SDK_PATH"
          EOF

          source ~/.bashrc

          echo "Verifying environment variables:"
          echo "XCPKG_COMPILER_C=$XCPKG_COMPILER_C"
          echo "XCPKG_COMPILER_ARGS=$XCPKG_COMPILER_ARGS"
          echo "XCPKG_NATIVE_COMPILER_C=$XCPKG_NATIVE_COMPILER_C"
          echo "XCPKG_NATIVE_COMPILER_ARGS=$XCPKG_NATIVE_COMPILER_ARGS"

      - name: Build ImageMagick with xcpkg
        shell: bash -leo pipefail {0}
        run: |
          source ~/.bashrc
          ./xcpkg install MacOSX-14.0-arm64/imagemagick --profile=release

      - run: ./xcpkg pack MacOSX-14.0-arm64/imagemagick -t tar.gz -o .

      - run: mv imagemagick-*.tar.gz imagemagick-macos-arm64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: imagemagick-macos-arm64
          path: imagemagick-macos-arm64.tar.gz

  release:
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update 'latest' release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest ImageMagick Build
          body: |
            Latest ImageMagick built with xcpkg (like How to Convert)

            ## Files:

            - `imagemagick-macos-x86_64.tar.gz` - **Intel Macs** (x86_64)
            - `imagemagick-macos-arm64.tar.gz` - **Apple Silicon** (ARM64)

            Built using xcpkg with How to Convert's imagemagick formula.
            Compatible with macOS 11+.
          files: |
            artifacts/**/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
