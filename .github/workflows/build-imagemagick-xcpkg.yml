name: Build ImageMagick with xcpkg

on:
  workflow_dispatch:

jobs:
  build-x86_64:
    runs-on: macos-13

    steps:
      - run: export -p

      - run: curl -LO https://raw.githubusercontent.com/leleliu008/xcpkg/master/xcpkg
      - run: chmod a+x xcpkg
      - run: ./xcpkg setup
      - run: ./xcpkg update

      # Download custom imagemagick formula with libraw support
      - run: |
          mkdir -p ~/.xcpkg/repos.d/official-core/formula
          curl -o ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml https://raw.githubusercontent.com/jakemanger/xcpkg-formula-repository-official-core/master/formula/imagemagick.yml

      - name: Patch xcpkg wrapper scripts to use clang directly
        run: |
          SDK_PATH="$(xcrun --show-sdk-path)"
          echo "SDK Path: $SDK_PATH"
          
          # Create wrapper-native-cc
          echo '#!/bin/sh' > ~/.xcpkg/core/wrapper-native-cc
          echo 'SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '"''"')"' >> ~/.xcpkg/core/wrapper-native-cc
          echo 'if [ -n "$SDK_PATH" ]; then' >> ~/.xcpkg/core/wrapper-native-cc
          echo '  exec /usr/bin/clang -arch x86_64 -mmacosx-version-min=13.0 -isysroot "$SDK_PATH" "$@"' >> ~/.xcpkg/core/wrapper-native-cc
          echo 'else' >> ~/.xcpkg/core/wrapper-native-cc
          echo '  exec /usr/bin/clang -arch x86_64 -mmacosx-version-min=13.0 "$@"' >> ~/.xcpkg/core/wrapper-native-cc
          echo 'fi' >> ~/.xcpkg/core/wrapper-native-cc
          chmod +x ~/.xcpkg/core/wrapper-native-cc
          
          # Create wrapper-native-c++
          echo '#!/bin/sh' > ~/.xcpkg/core/wrapper-native-c++
          echo 'SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '"''"')"' >> ~/.xcpkg/core/wrapper-native-c++
          echo 'if [ -n "$SDK_PATH" ]; then' >> ~/.xcpkg/core/wrapper-native-c++
          echo '  exec /usr/bin/clang++ -arch x86_64 -mmacosx-version-min=13.0 -isysroot "$SDK_PATH" "$@"' >> ~/.xcpkg/core/wrapper-native-c++
          echo 'else' >> ~/.xcpkg/core/wrapper-native-c++
          echo '  exec /usr/bin/clang++ -arch x86_64 -mmacosx-version-min=13.0 "$@"' >> ~/.xcpkg/core/wrapper-native-c++
          echo 'fi' >> ~/.xcpkg/core/wrapper-native-c++
          chmod +x ~/.xcpkg/core/wrapper-native-c++
          
          # Create wrapper-target-cc
          echo '#!/bin/sh' > ~/.xcpkg/core/wrapper-target-cc
          echo 'SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '"''"')"' >> ~/.xcpkg/core/wrapper-target-cc
          echo 'if [ -n "$SDK_PATH" ]; then' >> ~/.xcpkg/core/wrapper-target-cc
          echo '  exec /usr/bin/clang -arch x86_64 -mmacosx-version-min=13.0 -isysroot "$SDK_PATH" "$@"' >> ~/.xcpkg/core/wrapper-target-cc
          echo 'else' >> ~/.xcpkg/core/wrapper-target-cc
          echo '  exec /usr/bin/clang -arch x86_64 -mmacosx-version-min=13.0 "$@"' >> ~/.xcpkg/core/wrapper-target-cc
          echo 'fi' >> ~/.xcpkg/core/wrapper-target-cc
          chmod +x ~/.xcpkg/core/wrapper-target-cc
          
          # Create wrapper-target-c++
          echo '#!/bin/sh' > ~/.xcpkg/core/wrapper-target-c++
          echo 'SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '"''"')"' >> ~/.xcpkg/core/wrapper-target-c++
          echo 'if [ -n "$SDK_PATH" ]; then' >> ~/.xcpkg/core/wrapper-target-c++
          echo '  exec /usr/bin/clang++ -arch x86_64 -mmacosx-version-min=13.0 -isysroot "$SDK_PATH" "$@"' >> ~/.xcpkg/core/wrapper-target-c++
          echo 'else' >> ~/.xcpkg/core/wrapper-target-c++
          echo '  exec /usr/bin/clang++ -arch x86_64 -mmacosx-version-min=13.0 "$@"' >> ~/.xcpkg/core/wrapper-target-c++
          echo 'fi' >> ~/.xcpkg/core/wrapper-target-c++
          chmod +x ~/.xcpkg/core/wrapper-target-c++
          
          echo "Wrapper scripts patched successfully"

      - name: Build ImageMagick with xcpkg
        run: ./xcpkg install MacOSX-13.0-x86_64/imagemagick --profile=release

      - run: ./xcpkg pack MacOSX-13.0-x86_64/imagemagick -t tar.gz -o .

      - run: mv imagemagick-*.tar.gz imagemagick-macos-x86_64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: imagemagick-macos-x86_64
          path: imagemagick-macos-x86_64.tar.gz

  build-arm64:
    runs-on: macos-14

    steps:
      - run: export -p

      - run: curl -LO https://raw.githubusercontent.com/leleliu008/xcpkg/master/xcpkg
      - run: chmod a+x xcpkg
      - run: ./xcpkg setup
      - run: ./xcpkg update

      # Download custom imagemagick formula with libraw support
      - run: |
          mkdir -p ~/.xcpkg/repos.d/official-core/formula
          curl -o ~/.xcpkg/repos.d/official-core/formula/imagemagick.yml https://raw.githubusercontent.com/jakemanger/xcpkg-formula-repository-official-core/master/formula/imagemagick.yml

      - name: Patch xcpkg wrapper scripts to use clang directly
        run: |
          SDK_PATH="$(xcrun --show-sdk-path)"
          echo "SDK Path: $SDK_PATH"
          
          # Create wrapper-native-cc
          echo '#!/bin/sh' > ~/.xcpkg/core/wrapper-native-cc
          echo 'SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '"''"')"' >> ~/.xcpkg/core/wrapper-native-cc
          echo 'if [ -n "$SDK_PATH" ]; then' >> ~/.xcpkg/core/wrapper-native-cc
          echo '  exec /usr/bin/clang -arch arm64 -mmacosx-version-min=14.0 -isysroot "$SDK_PATH" "$@"' >> ~/.xcpkg/core/wrapper-native-cc
          echo 'else' >> ~/.xcpkg/core/wrapper-native-cc
          echo '  exec /usr/bin/clang -arch arm64 -mmacosx-version-min=14.0 "$@"' >> ~/.xcpkg/core/wrapper-native-cc
          echo 'fi' >> ~/.xcpkg/core/wrapper-native-cc
          chmod +x ~/.xcpkg/core/wrapper-native-cc
          
          # Create wrapper-native-c++
          echo '#!/bin/sh' > ~/.xcpkg/core/wrapper-native-c++
          echo 'SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '"''"')"' >> ~/.xcpkg/core/wrapper-native-c++
          echo 'if [ -n "$SDK_PATH" ]; then' >> ~/.xcpkg/core/wrapper-native-c++
          echo '  exec /usr/bin/clang++ -arch arm64 -mmacosx-version-min=14.0 -isysroot "$SDK_PATH" "$@"' >> ~/.xcpkg/core/wrapper-native-c++
          echo 'else' >> ~/.xcpkg/core/wrapper-native-c++
          echo '  exec /usr/bin/clang++ -arch arm64 -mmacosx-version-min=14.0 "$@"' >> ~/.xcpkg/core/wrapper-native-c++
          echo 'fi' >> ~/.xcpkg/core/wrapper-native-c++
          chmod +x ~/.xcpkg/core/wrapper-native-c++
          
          # Create wrapper-target-cc
          echo '#!/bin/sh' > ~/.xcpkg/core/wrapper-target-cc
          echo 'SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '"''"')"' >> ~/.xcpkg/core/wrapper-target-cc
          echo 'if [ -n "$SDK_PATH" ]; then' >> ~/.xcpkg/core/wrapper-target-cc
          echo '  exec /usr/bin/clang -arch arm64 -mmacosx-version-min=14.0 -isysroot "$SDK_PATH" "$@"' >> ~/.xcpkg/core/wrapper-target-cc
          echo 'else' >> ~/.xcpkg/core/wrapper-target-cc
          echo '  exec /usr/bin/clang -arch arm64 -mmacosx-version-min=14.0 "$@"' >> ~/.xcpkg/core/wrapper-target-cc
          echo 'fi' >> ~/.xcpkg/core/wrapper-target-cc
          chmod +x ~/.xcpkg/core/wrapper-target-cc
          
          # Create wrapper-target-c++
          echo '#!/bin/sh' > ~/.xcpkg/core/wrapper-target-c++
          echo 'SDK_PATH="$(xcrun --show-sdk-path 2>/dev/null || echo '"''"')"' >> ~/.xcpkg/core/wrapper-target-c++
          echo 'if [ -n "$SDK_PATH" ]; then' >> ~/.xcpkg/core/wrapper-target-c++
          echo '  exec /usr/bin/clang++ -arch arm64 -mmacosx-version-min=14.0 -isysroot "$SDK_PATH" "$@"' >> ~/.xcpkg/core/wrapper-target-c++
          echo 'else' >> ~/.xcpkg/core/wrapper-target-c++
          echo '  exec /usr/bin/clang++ -arch arm64 -mmacosx-version-min=14.0 "$@"' >> ~/.xcpkg/core/wrapper-target-c++
          echo 'fi' >> ~/.xcpkg/core/wrapper-target-c++
          chmod +x ~/.xcpkg/core/wrapper-target-c++
          
          echo "Wrapper scripts patched successfully"

      - name: Build ImageMagick with xcpkg
        run: ./xcpkg install MacOSX-14.0-arm64/imagemagick --profile=release

      - run: ./xcpkg pack MacOSX-14.0-arm64/imagemagick -t tar.gz -o .

      - run: mv imagemagick-*.tar.gz imagemagick-macos-arm64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: imagemagick-macos-arm64
          path: imagemagick-macos-arm64.tar.gz

  release:
    needs: [build-x86_64, build-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Update 'latest' release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest ImageMagick Build
          body: |
            Latest ImageMagick built with xcpkg (like How to Convert)

            ## Files:

            - `imagemagick-macos-x86_64.tar.gz` - **Intel Macs** (x86_64)
            - `imagemagick-macos-arm64.tar.gz` - **Apple Silicon** (ARM64)

            Built using xcpkg with How to Convert's imagemagick formula.
            Compatible with macOS 11+.
          files: |
            artifacts/**/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
